name: CD - è‡ªåŠ¨éƒ¨ç½²

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: npm install -g pnpm && pnpm install
    
    - name: æ„å»ºå…±äº«åŒ…
      run: |
        cd packages/shared
        npm run build
    
    - name: æ„å»ºåç«¯
      run: |
        cd packages/backend
        npm run build
    
    - name: æ„å»ºå‰ç«¯
      run: |
        cd packages/web
        npm run build
    
    - name: å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
      run: |
        mkdir -p deploy/backend
        mkdir -p deploy/web
        
        # å¤åˆ¶åç«¯æ–‡ä»¶
        cp -r packages/backend/dist deploy/backend/
        cp -r packages/backend/prisma deploy/backend/
        cp packages/backend/package.json deploy/backend/
        cp -r packages/backend/uploads deploy/backend/ 2>/dev/null || mkdir -p deploy/backend/uploads
        
        # å¤åˆ¶å‰ç«¯æ–‡ä»¶
        cp -r packages/web/dist deploy/web/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy/deploy-remote.sh << 'EOFSCRIPT'
        #!/bin/bash
        set -e
        
        REMOTE_DIR="/var/www/webnote"
        BACKUP_DIR="/var/backups/webnote"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        echo "ğŸ“¦ å¼€å§‹éƒ¨ç½²..."
        echo "ğŸ“… æ—¶é—´: $(date)"
        echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
        
        # æ£€æŸ¥PM2æœåŠ¡
        if pm2 status | grep -q "webnote-backend"; then
            echo "â¹ï¸  åœæ­¢ç°æœ‰æœåŠ¡..."
            pm2 stop webnote-backend || true
        fi
        
        # å¤‡ä»½ç°æœ‰ç‰ˆæœ¬
        echo "ğŸ’¾ å¤‡ä»½ç°æœ‰ç‰ˆæœ¬..."
        mkdir -p "$BACKUP_DIR"
        [ -d "$REMOTE_DIR/backend" ] && mv "$REMOTE_DIR/backend" "$BACKUP_DIR/backend_$TIMESTAMP" || true
        [ -d "$REMOTE_DIR/web" ] && mv "$REMOTE_DIR/web" "$BACKUP_DIR/web_$TIMESTAMP" || true
        
        # éƒ¨ç½²æ–°ç‰ˆæœ¬
        echo "ğŸš€ éƒ¨ç½²æ–°ç‰ˆæœ¬..."
        rm -rf "$REMOTE_DIR/backend"
        rm -rf "$REMOTE_DIR/web"
        
        cp -r /tmp/deploy/backend "$REMOTE_DIR/backend"
        cp -r /tmp/deploy/web "$REMOTE_DIR/web"
        
        # åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
        echo "âš™ï¸  é…ç½®ç¯å¢ƒå˜é‡..."
        cat > "$REMOTE_DIR/backend/.env" << 'ENVEOF'
        DATABASE_URL="postgresql://webnote_user:REDACTED_PASSWORD@localhost:5432/webnote_db"
        JWT_SECRET="${{ secrets.JWT_SECRET }}"
        PORT=3000
        NODE_ENV=production
        ALLOWED_ORIGINS="http://120.26.50.152,https://120.26.50.152"
        ENVEOF
        
        chmod 600 "$REMOTE_DIR/backend/.env"
        
        # è¿è¡Œæ•°æ®åº“è¿ç§»
        echo "ğŸ—„ï¸  è¿è¡Œæ•°æ®åº“è¿ç§»..."
        cd "$REMOTE_DIR/backend"
        npx prisma migrate deploy || echo "âš ï¸  æ•°æ®åº“è¿ç§»å¤±è´¥æˆ–æ— éœ€è¿ç§»"
        
        # é…ç½®Nginx
        echo "ğŸŒ é…ç½®Nginx..."
        cat > /tmp/webnote-nginx.conf << 'NGINXEOF'
        server {
            listen 80;
            server_name 120.26.50.152;
            
            # å‰ç«¯é™æ€æ–‡ä»¶
            location / {
                root /var/www/webnote/web/dist;
                try_files $uri $uri/ /index.html;
                add_header Cache-Control "public, max-age=3600";
            }
            
            # åç«¯APIä»£ç†
            location /api {
                proxy_pass http://localhost:3000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            
            client_max_body_size 10M;
            
            gzip on;
            gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
        }
        NGINXEOF
        
        sudo mv /tmp/webnote-nginx.conf /etc/nginx/sites-available/webnote
        sudo ln -sf /etc/nginx/sites-available/webnote /etc/nginx/sites-enabled/webnote
        sudo nginx -t && sudo systemctl reload nginx
        
        # å¯åŠ¨æœåŠ¡
        echo "â–¶ï¸  å¯åŠ¨æœåŠ¡..."
        cd "$REMOTE_DIR/backend"
        
        # æ£€æŸ¥æ˜¯å¦å·²é…ç½®PM2
        if ! pm2 status | grep -q "webnote-backend"; then
            pm2 start npm --name webnote-backend -- start
        else
            pm2 restart webnote-backend
        fi
        
        pm2 save
        
        # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
        echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½..."
        find "$BACKUP_DIR" -name "backend_*" -mtime +7 -delete 2>/dev/null || true
        find "$BACKUP_DIR" -name "web_*" -mtime +7 -delete 2>/dev/null || true
        
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo ""
        echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
        pm2 status
        echo ""
        echo "ğŸŒ è®¿é—®åœ°å€:"
        echo "  - å‰ç«¯: http://120.26.50.152"
        echo "  - åç«¯API: http://120.26.50.152/api"
        EOFSCRIPT
        
        chmod +x deploy/deploy-remote.sh
    
    - name: åˆ›å»ºå‹ç¼©åŒ…
      run: |
        tar -czf /tmp/deploy.tar.gz -C deploy .
        ls -lh /tmp/deploy.tar.gz
    
    - name: ä¸Šä¼ åˆ°æœåŠ¡å™¨
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "/tmp/deploy.tar.gz"
        target: "/tmp"
    
    - name: è§£å‹å¹¶éƒ¨ç½²
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          cd /tmp
          tar -xzf deploy.tar.gz -C /tmp/deploy
          bash /tmp/deploy/deploy-remote.sh
          rm -rf /tmp/deploy /tmp/deploy.tar.gz
    
    - name: å¥åº·æ£€æŸ¥
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 10
        
        echo "ğŸ” æ£€æŸ¥åç«¯API..."
        response=$(curl -s -o /dev/null -w "%{http_code}" http://120.26.50.152/api/health || echo "000")
        
        if [ "$response" = "200" ]; then
            echo "âœ… åç«¯APIæ­£å¸¸ (HTTP $response)"
        else
            echo "âŒ åç«¯APIå¼‚å¸¸ (HTTP $response)"
            exit 1
        fi
        
        echo "ğŸ” æ£€æŸ¥å‰ç«¯é¡µé¢..."
        response=$(curl -s -o /dev/null -w "%{http_code}" http://120.26.50.152/ || echo "000")
        
        if [ "$response" = "200" ]; then
            echo "âœ… å‰ç«¯é¡µé¢æ­£å¸¸ (HTTP $response)"
        else
            echo "âŒ å‰ç«¯é¡µé¢å¼‚å¸¸ (HTTP $response)"
            exit 1
        fi
    
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ github.sha }}"
        echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
        echo "ğŸ”— æäº¤: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
    
    - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ github.sha }}"
        echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
        echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å›æ»š"
