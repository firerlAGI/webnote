name: ÂÅ•Â∫∑Ê£ÄÊü•

on:
  schedule:
    # ÊØèÂ∞èÊó∂Ê£ÄÊü•‰∏ÄÊ¨°
    - cron: '0 * * * *'
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  health-check:
    name: Áîü‰∫ßÁéØÂ¢ÉÂÅ•Â∫∑Ê£ÄÊü•
    runs-on: ubuntu-latest
    
    steps:
    - name: Ê£ÄÊü•ÂêéÁ´ØAPI
      id: check-backend
      run: |
        echo "üîç Ê£ÄÊü•ÂêéÁ´ØAPIÂÅ•Â∫∑Áä∂ÊÄÅ..."
        
        response=$(curl -s -w "\n%{http_code}" http://120.26.50.152/api/health --connect-timeout 10)
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | head -n-1)
        
        echo "HTTPÁä∂ÊÄÅÁ†Å: $http_code"
        echo "ÂìçÂ∫î‰Ωì: $body"
        
        if [ "$http_code" = "200" ]; then
            echo "‚úÖ ÂêéÁ´ØAPIÊ≠£Â∏∏"
            echo "status=healthy" >> $GITHUB_OUTPUT
        else
            echo "‚ùå ÂêéÁ´ØAPIÂºÇÂ∏∏"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            exit 1
        fi
    
    - name: Ê£ÄÊü•ÂâçÁ´ØÈ°µÈù¢
      id: check-frontend
      run: |
        echo "üîç Ê£ÄÊü•ÂâçÁ´ØÈ°µÈù¢..."
        
        response=$(curl -s -w "\n%{http_code}" http://120.26.50.152/ --connect-timeout 10)
        http_code=$(echo "$response" | tail -n1)
        
        echo "HTTPÁä∂ÊÄÅÁ†Å: $http_code"
        
        if [ "$http_code" = "200" ]; then
            echo "‚úÖ ÂâçÁ´ØÈ°µÈù¢Ê≠£Â∏∏"
            echo "status=healthy" >> $GITHUB_OUTPUT
        else
            echo "‚ùå ÂâçÁ´ØÈ°µÈù¢ÂºÇÂ∏∏"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            exit 1
        fi
    
    - name: Ê£ÄÊü•Êï∞ÊçÆÂ∫ìËøûÊé•
      id: check-database
      run: |
        echo "üîç Ê£ÄÊü•Êï∞ÊçÆÂ∫ìËøûÊé•..."
        
        # ‰ΩøÁî®curlÊµãËØïÊï∞ÊçÆÂ∫ìAPIÁ´ØÁÇπÔºàÂ¶ÇÊûúÊúâÔºâ
        response=$(curl -s -w "\n%{http_code}" http://120.26.50.152/api/health/db --connect-timeout 10 2>/dev/null || echo "000")
        http_code=$(echo "$response" | tail -n1)
        
        if [ "$http_code" = "200" ]; then
            echo "‚úÖ Êï∞ÊçÆÂ∫ìËøûÊé•Ê≠£Â∏∏"
            echo "status=healthy" >> $GITHUB_OUTPUT
        else
            echo "‚ö†Ô∏è  Êó†Ê≥ïÁõ¥Êé•Ê£ÄÊü•Êï∞ÊçÆÂ∫ìËøûÊé•ÔºàÂèØËÉΩÁº∫Â∞ëÁõ∏ÂÖ≥APIÔºâ"
            echo "status=skipped" >> $GITHUB_OUTPUT
        fi
    
    - name: ÁîüÊàêÂÅ•Â∫∑Êä•Âëä
      if: always()
      run: |
        echo ""
        echo "üìä ÂÅ•Â∫∑Ê£ÄÊü•Êä•Âëä"
        echo "================"
        echo "Êó∂Èó¥: $(date)"
        echo "ÂêéÁ´ØAPI: ${{ steps.check-backend.outputs.status }}"
        echo "ÂâçÁ´ØÈ°µÈù¢: ${{ steps.check-frontend.outputs.status }}"
        echo "Êï∞ÊçÆÂ∫ì: ${{ steps.check-database.outputs.status }}"
        echo ""
        echo "ËØ¶ÁªÜÊó•Âøó: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    
    - name: ÂàõÂª∫IssueÈÄöÁü•
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const title = `üö® Áîü‰∫ßÁéØÂ¢ÉÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥• - ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}`;
          const body = `
          ## ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•
          
          **Ê£ÄÊü•Êó∂Èó¥:** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
          
          **Ê£ÄÊü•ÁªìÊûú:**
          - ÂêéÁ´ØAPI: ${{ steps.check-backend.outputs.status }}
          - ÂâçÁ´ØÈ°µÈù¢: ${{ steps.check-frontend.outputs.status }}
          - Êï∞ÊçÆÂ∫ì: ${{ steps.check-database.outputs.status }}
          
          **Â∑•‰ΩúÊµÅÈìæÊé•:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ËØ∑Á´ãÂç≥Ê£ÄÊü•ÊúçÂä°Âô®Áä∂ÊÄÅÔºÅ
          `;
          
          // ÂàõÂª∫ÊàñÊõ¥Êñ∞Issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['health-check', 'urgent']
          });
          
          const existingIssue = issues.data.find(issue => issue.title.includes('ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•'));
          
          if (existingIssue) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: body
            });
          } else {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['health-check', 'urgent']
            });
          }
