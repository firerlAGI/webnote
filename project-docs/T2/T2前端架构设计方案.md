# T2项目前端Web应用架构设计方案

## 1. 架构概述

基于现有的项目结构和后端API，T2项目的前端Web应用将采用现代化的React + TypeScript + Vite技术栈，构建一个功能完整的笔记和复盘应用。前端应用将与后端API紧密集成，实现用户认证、笔记管理、Markdown编辑和日复盘等核心功能。

## 2. 技术栈选择

| 类别 | 技术 | 版本 | 选型理由 |
|------|------|------|---------|
| 前端框架 | React | 18.x | 组件化开发、生态成熟、性能优异 |
| 类型系统 | TypeScript | 5.x | 类型安全、代码可维护性高、开发体验好 |
| 构建工具 | Vite | 5.x | 快速的开发体验、现代化的构建流程、优化的生产打包 |
| 状态管理 | React Context API + useReducer | 内置 | 轻量级、无需额外依赖、适合中小型应用 |
| 路由管理 | React Router | 6.x | 声明式路由、嵌套路由支持、良好的类型定义 |
| HTTP客户端 | 自定义ApiClient (基于fetch) | 内置 | 轻量级、可扩展、与后端API无缝集成 |
| 数据验证 | Zod | 3.x | 类型安全、强大的验证能力、与TypeScript配合良好 |
| 样式方案 | CSS Modules + PostCSS | 内置 | 模块化、避免命名冲突、支持现代CSS特性 |
| UI组件 | 自定义组件库 | 自研 | 灵活定制、统一风格、减少第三方依赖 |
| Markdown编辑 | React-Markdown + Remark | 9.x | 轻量级、可扩展、支持自定义插件 |
| 图表库 | Recharts | 2.x | 响应式、功能丰富、适合数据可视化 |
| 测试工具 | Vitest + React Testing Library | 1.x | 快速、与Vite集成良好、符合现代测试理念 |

## 3. 项目结构

```
packages/
├── backend/          # 后端服务
├── shared/           # 共享代码
└── web/              # 前端Web应用
    ├── public/        # 静态资源
    ├── src/           # 源代码
    │   ├── assets/    # 资源文件
    │   ├── components/ # 组件
    │   │   ├── common/   # 通用组件
    │   │   ├── auth/     # 认证相关组件
    │   │   ├── notes/    # 笔记相关组件
    │   │   ├── folders/  # 文件夹相关组件
    │   │   └── reviews/  # 复盘相关组件
    │   ├── contexts/   # 上下文
    │   ├── hooks/      # 自定义钩子
    │   ├── pages/      # 页面
    │   ├── services/   # 服务
    │   ├── types/      # 类型定义
    │   ├── utils/      # 工具函数
    │   ├── routes/     # 路由配置
    │   ├── App.tsx     # 应用根组件
    │   └── main.tsx    # 应用入口
    ├── index.html      # HTML模板
    ├── tsconfig.json   # TypeScript配置
    ├── vite.config.ts  # Vite配置
    └── package.json    # 包配置
```

### 3.1 核心目录说明

- **components/**: 存放所有React组件，按功能模块分类
- **contexts/**: 存放React Context，用于全局状态管理
- **hooks/**: 存放自定义React Hooks，封装复用逻辑
- **pages/**: 存放页面组件，对应路由
- **services/**: 存放服务层代码，包括API调用
- **types/**: 存放TypeScript类型定义
- **utils/**: 存放通用工具函数
- **routes/**: 存放路由配置

## 4. 组件规划

### 4.1 通用组件

| 组件名称 | 功能描述 | 位置 |
|---------|---------|------|
| Button | 按钮组件 | components/common/Button.tsx |
| Input | 输入框组件 | components/common/Input.tsx |
| Textarea | 文本域组件 | components/common/Textarea.tsx |
| Select | 选择器组件 | components/common/Select.tsx |
| Modal | 模态框组件 | components/common/Modal.tsx |
| Toast | 消息提示组件 | components/common/Toast.tsx |
| Loading | 加载组件 | components/common/Loading.tsx |
| Empty | 空状态组件 | components/common/Empty.tsx |
| Pagination | 分页组件 | components/common/Pagination.tsx |
| Dropdown | 下拉菜单组件 | components/common/Dropdown.tsx |
| Tooltip | 提示组件 | components/common/Tooltip.tsx |

### 4.2 认证相关组件

| 组件名称 | 功能描述 | 位置 |
|---------|---------|------|
| LoginForm | 登录表单 | components/auth/LoginForm.tsx |
| RegisterForm | 注册表单 | components/auth/RegisterForm.tsx |
| ForgotPasswordForm | 忘记密码表单 | components/auth/ForgotPasswordForm.tsx |
| AuthLayout | 认证页面布局 | components/auth/AuthLayout.tsx |

### 4.3 笔记相关组件

| 组件名称 | 功能描述 | 位置 |
|---------|---------|------|
| NoteList | 笔记列表 | components/notes/NoteList.tsx |
| NoteItem | 笔记项 | components/notes/NoteItem.tsx |
| NoteEditor | 笔记编辑器 | components/notes/NoteEditor.tsx |
| MarkdownEditor | Markdown编辑器 | components/notes/MarkdownEditor.tsx |
| NoteHeader | 笔记头部 | components/notes/NoteHeader.tsx |
| NoteSidebar | 笔记侧边栏 | components/notes/NoteSidebar.tsx |
| NoteVersions | 笔记版本历史 | components/notes/NoteVersions.tsx |

### 4.4 文件夹相关组件

| 组件名称 | 功能描述 | 位置 |
|---------|---------|------|
| FolderList | 文件夹列表 | components/folders/FolderList.tsx |
| FolderItem | 文件夹项 | components/folders/FolderItem.tsx |
| FolderForm | 文件夹表单 | components/folders/FolderForm.tsx |

### 4.5 复盘相关组件

| 组件名称 | 功能描述 | 位置 |
|---------|---------|------|
| ReviewList | 复盘列表 | components/reviews/ReviewList.tsx |
| ReviewItem | 复盘项 | components/reviews/ReviewItem.tsx |
| ReviewEditor | 复盘编辑器 | components/reviews/ReviewEditor.tsx |
| ReviewHeader | 复盘头部 | components/reviews/ReviewHeader.tsx |
| ReviewStats | 复盘统计 | components/reviews/ReviewStats.tsx |
| ReviewCalendar | 复盘日历 | components/reviews/ReviewCalendar.tsx |
| ReviewTemplate | 复盘模板 | components/reviews/ReviewTemplate.tsx |

## 5. 状态管理设计

### 5.1 全局状态结构

使用React Context API + useReducer实现全局状态管理，主要包含以下几个Context：

1. **AuthContext**: 管理用户认证状态
2. **NotesContext**: 管理笔记相关状态
3. **FoldersContext**: 管理文件夹相关状态
4. **ReviewsContext**: 管理复盘相关状态
5. **UIContext**: 管理UI相关状态（如主题、布局等）

### 5.2 AuthContext 设计

```typescript
// contexts/AuthContext.tsx
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  error: string | null;
}

type AuthAction =
  | { type: 'LOGIN_START' }
  | { type: 'LOGIN_SUCCESS'; payload: { user: User; token: string } }
  | { type: 'LOGIN_FAILURE'; payload: string }
  | { type: 'LOGOUT' }
  | { type: 'UPDATE_USER'; payload: User };

// 初始状态
const initialState: AuthState = {
  user: null,
  token: null,
  isAuthenticated: false,
  isLoading: false,
  error: null,
};

// Reducer
const authReducer = (state: AuthState, action: AuthAction): AuthState => {
  switch (action.type) {
    case 'LOGIN_START':
      return { ...state, isLoading: true, error: null };
    case 'LOGIN_SUCCESS':
      return {
        ...state,
        isLoading: false,
        isAuthenticated: true,
        user: action.payload.user,
        token: action.payload.token,
        error: null,
      };
    case 'LOGIN_FAILURE':
      return {
        ...state,
        isLoading: false,
        error: action.payload,
      };
    case 'LOGOUT':
      return initialState;
    case 'UPDATE_USER':
      return {
        ...state,
        user: action.payload,
      };
    default:
      return state;
  }
};
```

### 5.3 NotesContext 设计

```typescript
// contexts/NotesContext.tsx
interface NotesState {
  notes: Note[];
  currentNote: Note | null;
  isLoading: boolean;
  error: string | null;
  filters: {
    folderId?: number;
    searchQuery: string;
    sortBy: 'created_at' | 'updated_at' | 'last_accessed_at';
    sortOrder: 'asc' | 'desc';
  };
}

type NotesAction =
  | { type: 'FETCH_NOTES_START' }
  | { type: 'FETCH_NOTES_SUCCESS'; payload: Note[] }
  | { type: 'FETCH_NOTES_FAILURE'; payload: string }
  | { type: 'SET_CURRENT_NOTE'; payload: Note | null }
  | { type: 'CREATE_NOTE'; payload: Note }
  | { type: 'UPDATE_NOTE'; payload: Note }
  | { type: 'DELETE_NOTE'; payload: number }
  | { type: 'UPDATE_FILTERS'; payload: Partial<NotesState['filters']> };

// 初始状态
const initialState: NotesState = {
  notes: [],
  currentNote: null,
  isLoading: false,
  error: null,
  filters: {
    searchQuery: '',
    sortBy: 'updated_at',
    sortOrder: 'desc',
  },
};

// Reducer
const notesReducer = (state: NotesState, action: NotesAction): NotesState => {
  switch (action.type) {
    case 'FETCH_NOTES_START':
      return { ...state, isLoading: true, error: null };
    case 'FETCH_NOTES_SUCCESS':
      return { ...state, isLoading: false, notes: action.payload };
    case 'FETCH_NOTES_FAILURE':
      return { ...state, isLoading: false, error: action.payload };
    case 'SET_CURRENT_NOTE':
      return { ...state, currentNote: action.payload };
    case 'CREATE_NOTE':
      return { ...state, notes: [action.payload, ...state.notes] };
    case 'UPDATE_NOTE':
      return {
        ...state,
        notes: state.notes.map(note =>
          note.id === action.payload.id ? action.payload : note
        ),
        currentNote:
          state.currentNote?.id === action.payload.id
            ? action.payload
            : state.currentNote,
      };
    case 'DELETE_NOTE':
      return {
        ...state,
        notes: state.notes.filter(note => note.id !== action.payload),
        currentNote:
          state.currentNote?.id === action.payload ? null : state.currentNote,
      };
    case 'UPDATE_FILTERS':
      return { ...state, filters: { ...state.filters, ...action.payload } };
    default:
      return state;
  }
};
```

## 6. 路由设计

### 6.1 路由结构

```typescript
// routes/index.tsx
import { createBrowserRouter } from 'react-router-dom';
import App from '../App';
import AuthLayout from '../components/auth/AuthLayout';
import LoginPage from '../pages/LoginPage';
import RegisterPage from '../pages/RegisterPage';
import ForgotPasswordPage from '../pages/ForgotPasswordPage';
import NotesPage from '../pages/NotesPage';
import NoteDetailPage from '../pages/NoteDetailPage';
import ReviewsPage from '../pages/ReviewsPage';
import ReviewDetailPage from '../pages/ReviewDetailPage';
import ReviewStatsPage from '../pages/ReviewStatsPage';
import SettingsPage from '../pages/SettingsPage';
import NotFoundPage from '../pages/NotFoundPage';
import ProtectedRoute from '../components/common/ProtectedRoute';

const router = createBrowserRouter([
  {
    path: '/',
    element: <App />,
    children: [
      // 认证相关路由
      {
        path: 'auth',
        element: <AuthLayout />,
        children: [
          { path: 'login', element: <LoginPage /> },
          { path: 'register', element: <RegisterPage /> },
          { path: 'forgot-password', element: <ForgotPasswordPage /> },
        ],
      },
      // 受保护的路由
      {
        path: '',
        element: <ProtectedRoute />,
        children: [
          { path: '', element: <NotesPage /> },
          { path: 'notes', element: <NotesPage /> },
          { path: 'notes/:id', element: <NoteDetailPage /> },
          { path: 'reviews', element: <ReviewsPage /> },
          { path: 'reviews/:id', element: <ReviewDetailPage /> },
          { path: 'reviews/stats', element: <ReviewStatsPage /> },
          { path: 'settings', element: <SettingsPage /> },
        ],
      },
      // 404页面
      { path: '*', element: <NotFoundPage /> },
    ],
  },
]);

export default router;
```

### 6.2 路由守卫

使用ProtectedRoute组件实现路由守卫，确保只有认证用户能访问受保护的路由：

```typescript
// components/common/ProtectedRoute.tsx
import { Navigate, Outlet } from 'react-router-dom';
import { useAuth } from '../../hooks/useAuth';

const ProtectedRoute = () => {
  const { isAuthenticated, isLoading } = useAuth();

  if (isLoading) {
    // 可以返回一个加载组件
    return <div>Loading...</div>;
  }

  if (!isAuthenticated) {
    return <Navigate to="/auth/login" replace />;
  }

  return <Outlet />;
};

export default ProtectedRoute;
```

## 7. 核心功能实现方案

### 7.1 用户认证

#### 登录流程

1. 用户输入邮箱和密码
2. 前端验证输入合法性（使用Zod）
3. 调用登录API (`/auth/login`)
4. 登录成功后，存储token到localStorage并更新AuthContext
5. 登录失败后，显示错误信息

#### 注册流程

1. 用户输入用户名、邮箱和密码
2. 前端验证输入合法性（使用Zod）
3. 调用注册API (`/auth/register`)
4. 注册成功后，自动登录并跳转到首页
5. 注册失败后，显示错误信息

#### 权限控制

- 使用ProtectedRoute组件保护需要认证的路由
- 在API请求中自动携带token（通过ApiClient的请求拦截器）
- 处理token过期的情况（401错误时跳转到登录页）

### 7.2 笔记管理

#### 笔记列表

1. 从NotesContext获取笔记列表
2. 支持按文件夹筛选、关键词搜索、排序
3. 实现虚拟滚动（当笔记数量较多时）
4. 支持笔记的置顶、删除等操作

#### 笔记编辑

1. 使用Markdown编辑器（React-Markdown）
2. 支持实时预览
3. 自动保存功能（防抖处理，避免频繁API调用）
4. 版本历史记录与恢复
5. 支持标签管理

#### 笔记同步

1. 使用定时同步机制（如每5分钟）
2. 离线编辑支持（PWA功能）
3. 冲突检测与解决
4. 同步状态提示

### 7.3 Markdown编辑

#### 编辑器功能

1. 语法高亮
2. 快捷键支持
3. 工具栏（加粗、斜体、列表等）
4. 代码块语法高亮
5. 表格编辑支持
6. 图片上传支持

#### 渲染功能

1. 支持标准Markdown语法
2. 支持GFM（GitHub Flavored Markdown）
3. 支持数学公式
4. 支持代码块语法高亮
5. 支持自定义样式

### 7.4 日复盘功能

#### 复盘创建

1. 选择复盘日期
2. 填写复盘内容
3. 记录心情指数
4. 填写成就、改进点和计划
5. 支持使用模板

#### 复盘统计

1. 心情趋势图表
2. 成就统计
3. 改进点分析
4. 计划完成率

#### 复盘分析

1. 月度/季度复盘分析
2. 关键词提取
3. 趋势分析
4. 可视化图表展示

## 8. 与后端API集成

### 8.1 API客户端使用

使用现有的ApiClient与后端API集成：

```typescript
// services/authService.ts
import apiClient from '@webnote/shared/api';
import { User, LoginInput, UserInput } from '@webnote/shared/types';

export const authService = {
  // 登录
  login: async (data: LoginInput) => {
    const response = await apiClient.post<{ user: User; token: string }>(
      '/auth/login',
      data,
      { requireAuth: false }
    );
    return response;
  },

  // 注册
  register: async (data: UserInput) => {
    const response = await apiClient.post<{ user: User; token: string }>(
      '/auth/register',
      data,
      { requireAuth: false }
    );
    return response;
  },

  // 获取当前用户信息
  getCurrentUser: async () => {
    const response = await apiClient.get<User>('/auth/me');
    return response;
  },

  // 登出
  logout: async () => {
    const response = await apiClient.post('/auth/logout');
    return response;
  },
};
```

### 8.2 错误处理

实现统一的错误处理机制：

```typescript
// utils/errorHandler.ts
export const handleApiError = (error: any): string => {
  if (error.response) {
    // 服务器返回错误状态码
    return error.response.data.message || '服务器错误';
  } else if (error.request) {
    // 请求已发送但没有收到响应
    return '网络错误，请检查您的网络连接';
  } else {
    // 请求配置出错
    return error.message || '未知错误';
  }
};
```

### 8.3 请求状态管理

使用自定义Hook管理API请求状态：

```typescript
// hooks/useApi.ts
import { useState, useCallback } from 'react';

export const useApi = <T, P = void>(
  apiFn: (params: P) => Promise<T>
) => {
  const [data, setData] = useState<T | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const execute = useCallback(async (params: P) => {
    setIsLoading(true);
    setError(null);
    try {
      const result = await apiFn(params);
      setData(result);
      return result;
    } catch (err: any) {
      setError(err.message || '请求失败');
      throw err;
    } finally {
      setIsLoading(false);
    }
  }, [apiFn]);

  return { data, isLoading, error, execute };
};
```

## 9. 性能优化策略

### 9.1 构建优化

1. **代码分割**：使用动态导入（`React.lazy`和`suspense`）分割代码，减少初始加载时间
2. **树摇**：利用ES模块的静态分析，移除未使用的代码
3. **生产优化**：Vite默认的生产构建配置，包括代码压缩、资源优化等
4. **预加载**：对关键资源使用`<link rel="preload">`进行预加载
5. **缓存策略**：合理配置HTTP缓存头，利用浏览器缓存

### 9.2 运行时优化

1. **组件懒加载**：对非首屏组件使用`React.lazy`进行懒加载
2. **虚拟滚动**：对长列表使用虚拟滚动，减少DOM节点数量
3. **记忆化**：使用`React.memo`、`useMemo`和`useCallback`减少不必要的渲染
4. **防抖与节流**：对频繁触发的事件（如输入、滚动）使用防抖或节流处理
5. **批量更新**：利用React 18的自动批处理，减少渲染次数

### 9.3 网络优化

1. **API请求优化**：
   - 使用防抖处理搜索请求
   - 实现请求缓存
   - 合并重复请求
   - 使用分页和过滤减少数据传输量

2. **资源优化**：
   - 图片懒加载
   - 图片压缩与格式优化
   - 使用CDN分发静态资源

### 9.4 渲染优化

1. **减少重排重绘**：
   - 使用CSS transform代替top/left等属性
   - 避免在渲染过程中修改DOM
   - 使用will-change提示浏览器优化

2. **优化渲染路径**：
   - 减少组件层级
   - 避免在render中创建新函数和对象
   - 使用CSS Grid和Flexbox进行布局

## 10. 测试策略

### 10.1 测试类型

| 测试类型 | 工具 | 覆盖范围 |
|---------|------|---------|
| 单元测试 | Vitest | 工具函数、Hook、简单组件 |
| 集成测试 | Vitest + React Testing Library | 组件交互、API调用 |
| E2E测试 | Cypress | 完整用户流程、关键功能 |
| 性能测试 | Lighthouse | 页面加载性能、交互性能 |

### 10.2 测试覆盖率目标

- 工具函数：100%
- 核心Hook：100%
- 关键组件：80%+
- 业务逻辑：80%+

### 10.3 测试流程

1. 开发过程中编写单元测试
2. 提交代码前运行测试套件
3. CI/CD流程中自动运行测试
4. 定期运行E2E测试和性能测试

## 11. 部署策略

### 11.1 构建流程

1. 安装依赖：`pnpm install`
2. 类型检查：`pnpm run type-check`
3. 运行测试：`pnpm run test`
4. 构建生产版本：`pnpm run build`

### 11.2 部署环境

| 环境 | URL | 配置 |
|------|-----|------|
| 开发环境 | http://localhost:5173 | 本地开发配置 |
| 测试环境 | https://test.webnote.app | 测试配置，与生产环境相似 |
| 生产环境 | https://webnote.app | 生产配置，优化性能和安全性 |

### 11.3 部署方式

1. **静态部署**：将构建后的静态文件部署到CDN或静态文件服务器
2. **容器化部署**：使用Docker容器化部署
3. **CI/CD集成**：使用GitHub Actions自动构建和部署

### 11.4 监控与告警

1. **性能监控**：使用Lighthouse CI监控性能指标
2. **错误监控**：使用Sentry捕获前端错误
3. **用户行为分析**：使用Google Analytics或Matomo分析用户行为
4. **告警机制**：配置性能和错误阈值告警

## 12. 扩展性与可维护性

### 12.1 代码规范

- 使用ESLint和Prettier确保代码风格一致
- 遵循TypeScript最佳实践
- 编写清晰的注释和文档
- 使用有意义的命名规范

### 12.2 模块化设计

- 组件化开发，遵循单一职责原则
- 服务层与UI层分离
- 工具函数复用
- 配置中心化管理

### 12.3 可扩展性

- 插件机制：支持功能扩展
- 主题系统：支持自定义主题
- 国际化：预留i18n支持
- PWA支持：实现渐进式Web应用功能

### 12.4 维护性

- 完善的错误处理机制
- 详细的日志记录
- 定期代码审查
- 技术债务管理

## 13. 总结

本架构设计方案基于React + TypeScript + Vite技术栈，为T2项目的前端Web应用提供了详细的技术实现路径。方案涵盖了技术选型、项目结构、组件规划、状态管理、路由设计、核心功能实现、后端API集成、性能优化、测试策略和部署策略等多个方面。

通过采用现代化的前端技术和最佳实践，本方案旨在构建一个性能优异、用户体验良好、代码可维护性高的笔记和复盘应用。同时，方案充分考虑了与现有后端API的集成，确保前后端协同工作，为用户提供完整的功能体验。

本架构设计方案具有良好的扩展性和可维护性，能够支持项目的长期发展和功能迭代。