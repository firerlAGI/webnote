# T2项目改进建议详细说明

## 文档概述

本文档详细说明了T2项目需要改进的各个方面，包括改进建议、原因分析、风险评估和实施计划。所有建议基于对项目代码、架构、质量和部署准备情况的全面评估。

**评估日期**: 2026-01-10  
**项目当前状态**: 功能完整但质量不足，适合内部使用，不建议生产环境部署  
**总体完成度**: 66%

---

## 目录

1. [立即行动项（阻塞部署）](#立即行动项阻塞部署)
2. [短期行动项（1-2周内）](#短期行动项1-2周内)
3. [中期行动项（1个月内）](#中期行动项1个月内)
4. [长期优化建议](#长期优化建议)

---

## 立即行动项（阻塞部署）

### 1. 添加基础测试

#### 改进内容
为核心业务逻辑添加单元测试和集成测试，至少覆盖以下模块：
- [AuthContext.tsx](file:///Users/fire/Desktop/webnote/packages/web/src/contexts/AuthContext.tsx) - 认证状态管理
- [NotesContext.tsx](file:///Users/fire/Desktop/webnote/packages/web/src/contexts/NotesContext.tsx) - 笔记管理
- [ReviewsContext.tsx](file:///Users/fire/Desktop/webnote/packages/web/src/contexts/ReviewsContext.tsx) - 复盘系统
- [routes.ts](file:///Users/fire/Desktop/webnote/packages/backend/src/api/routes.ts) - API路由
- [ApiClient.ts](file:///Users/fire/Desktop/webnote/packages/shared/src/api/ApiClient.ts) - API客户端

#### 为什么需要测试

**原因1：代码质量保障**
- 当前项目没有任何项目特定的测试文件
- 代码修改时无法验证是否破坏了现有功能
- 重构风险极高，任何改动都可能导致意想不到的bug

**原因2：生产环境风险**
- 没有测试的代码直接部署到生产环境风险巨大
- 用户可能会遇到各种未发现的问题
- 修复生产环境bug的成本远高于开发阶段

**原因3：团队协作需求**
- 没有测试，团队成员难以理解代码预期行为
- 代码审查效率低，难以发现逻辑错误
- 新人接手项目困难，容易引入bug

**原因4：技术债务积累**
- 随着项目规模增长，维护成本呈指数级上升
- 没有测试的保护，优化和重构变得极其危险
- 最终可能需要重写整个系统

#### 不测试的风险

| 风险类型 | 具体表现 | 影响 |
|---------|---------|------|
| 功能回归 | 新功能破坏旧功能 | 用户体验下降，用户流失 |
| 边界条件 | 未处理的边界情况导致崩溃 | 系统不稳定，数据丢失 |
| 错误处理 | 异常情况下处理不当 | 安全漏洞，数据泄露 |
| 性能问题 | 未发现的性能瓶颈 | 系统响应慢，资源消耗高 |
| 维护困难 | 代码难以理解和修改 | 开发效率低，成本高 |

#### 实施建议

**优先级1：核心Context测试**
```typescript
// 示例：AuthContext.test.tsx
describe('AuthContext', () => {
  it('should handle login successfully', async () => {
    const { result } = renderHook(() => useAuth(), {
      wrapper: AuthProvider
    })
    
    await act(async () => {
      await result.current.login('test@example.com', 'password')
    })
    
    expect(result.current.isAuthenticated).toBe(true)
    expect(result.current.user).toBeDefined()
  })
  
  it('should handle login failure', async () => {
    const { result } = renderHook(() => useAuth(), {
      wrapper: AuthProvider
    })
    
    await act(async () => {
      await result.current.login('invalid@example.com', 'wrong')
    })
    
    expect(result.current.error).toBeDefined()
    expect(result.current.isAuthenticated).toBe(false)
  })
})
```

**优先级2：API路由测试**
```typescript
// 示例：notes.test.ts
describe('Notes API', () => {
  it('should create a new note', async () => {
    const response = await app.inject({
      method: 'POST',
      url: '/api/notes',
      headers: { authorization: `Bearer ${token}` },
      payload: {
        title: 'Test Note',
        content: 'Test Content'
      }
    })
    
    expect(response.statusCode).toBe(201)
    expect(response.json().success).toBe(true)
  })
  
  it('should require authentication', async () => {
    const response = await app.inject({
      method: 'POST',
      url: '/api/notes',
      payload: {
        title: 'Test Note',
        content: 'Test Content'
      }
    })
    
    expect(response.statusCode).toBe(401)
  })
})
```

**优先级3：工具函数测试**
```typescript
// 示例：error.test.ts
describe('handleApiError', () => {
  it('should handle 401 error', () => {
    const error = new Error('Unauthorized')
    const response = { status: 401 }
    
    const result = handleApiError(error, response)
    
    expect(result).toBe('登录已过期，请重新登录')
  })
  
  it('should handle network error', () => {
    const error = new Error('Network Error')
    const response = { status: 0 }
    
    const result = handleApiError(error, response)
    
    expect(result).toBe('网络连接失败，请检查网络设置')
  })
})
```

#### 测试覆盖率目标

| 模块类型 | 目标覆盖率 | 优先级 |
|---------|-----------|--------|
| 核心Context | 90%+ | 高 |
| API路由 | 85%+ | 高 |
| 工具函数 | 95%+ | 高 |
| UI组件 | 70%+ | 中 |
| 集成测试 | 60%+ | 中 |
| E2E测试 | 关键流程100% | 低 |

#### 预估工作量
- 单元测试：2-3天
- 集成测试：1-2天
- 测试环境搭建：0.5天
- **总计：3.5-5.5天**

---

### 2. 创建Docker配置

#### 改进内容
创建完整的容器化配置，包括：
- Dockerfile（前端和后端各一个）
- docker-compose.yml（编排所有服务）
- .dockerignore文件
- 健康检查配置

#### 为什么需要Docker

**原因1：环境一致性**
- 开发环境、测试环境、生产环境配置可能不一致
- "在我的机器上能运行"问题常见
- 环境差异导致难以复现的bug

**原因2：部署简化**
- 当前部署需要手动配置Node.js、PostgreSQL、环境变量等
- 部署流程复杂，容易出错
- 回滚困难

**原因3：资源隔离**
- 不同项目依赖可能冲突
- 系统级依赖管理困难
- 资源使用不清晰

**原因4：扩展性**
- 难以水平扩展
- 无法利用容器编排工具
- 不适合云原生部署

#### 不使用Docker的风险

| 风险类型 | 具体表现 | 影响 |
|---------|---------|------|
| 环境不一致 | 开发、测试、生产环境差异大 | bug难以复现和修复 |
| 部署复杂 | 手动配置步骤多，易出错 | 部署失败率高，回滚困难 |
| 依赖冲突 | 系统依赖冲突导致应用无法运行 | 应用不稳定 |
| 扩展困难 | 无法快速扩展服务实例 | 性能瓶颈难以解决 |
| 成本高昂 | 需要专门运维人员维护服务器 | 运营成本高 |

#### 实施建议

**前端Dockerfile**
```dockerfile
# packages/web/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# 复制package文件
COPY package*.json ./
COPY packages/web/package*.json ./packages/web/
COPY packages/shared/package*.json ./packages/shared/

# 安装依赖
RUN npm ci

# 复制源代码
COPY packages/web ./packages/web
COPY packages/shared ./packages/shared

# 构建应用
RUN npm run build -- --filter=web

# 生产环境
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/packages/web/dist /usr/share/nginx/html

# 复制nginx配置
COPY packages/web/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

**后端Dockerfile**
```dockerfile
# packages/backend/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# 复制package文件
COPY package*.json ./
COPY packages/backend/package*.json ./packages/backend/
COPY packages/shared/package*.json ./packages/shared/

# 安装依赖
RUN npm ci

# 复制源代码
COPY packages/backend ./packages/backend
COPY packages/shared ./packages/shared

# 构建应用
RUN npm run build -- --filter=backend

# 生产环境
FROM node:18-alpine

WORKDIR /app

# 复制package文件和构建产物
COPY packages/backend/package*.json ./packages/backend/
COPY --from=builder /app/packages/backend/dist ./packages/backend/dist
COPY --from=builder /app/packages/shared/dist ./packages/shared/dist

# 安装生产依赖
RUN npm ci --production --prefix=packages/backend

# 创建uploads目录
RUN mkdir -p /app/packages/backend/uploads

EXPOSE 3000

CMD ["node", "packages/backend/dist/server.js"]
```

**docker-compose.yml**
```yaml
version: '3.8'

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    container_name: webnote-postgres
    environment:
      POSTGRES_USER: ${DB_USER:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
      POSTGRES_DB: ${DB_NAME:-webnote}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-admin}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 后端服务
  backend:
    build:
      context: .
      dockerfile: packages/backend/Dockerfile
    container_name: webnote-backend
    environment:
      DATABASE_URL: postgresql://${DB_USER:-admin}:${DB_PASSWORD:-password}@postgres:5432/${DB_NAME:-webnote}
      JWT_SECRET: ${JWT_SECRET}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:80}
      PORT: 3000
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./packages/backend/uploads:/app/packages/backend/uploads
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 前端服务
  frontend:
    build:
      context: .
      dockerfile: packages/web/Dockerfile
    container_name: webnote-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:

networks:
  default:
    name: webnote-network
```

**.dockerignore**
```
node_modules
npm-debug.log
dist
.git
.gitignore
.env
.env.local
.env.*.local
coverage
.vscode
.idea
*.log
```

#### 预估工作量
- Dockerfile编写：0.5天
- docker-compose配置：0.5天
- 测试和调试：0.5天
- **总计：1.5天**

---

### 3. 配置生产环境变量

#### 改进内容
创建生产环境配置模板，包括：
- 环境变量文档说明
- 生产环境配置示例
- 安全的密钥管理方案
- 环境验证脚本

#### 为什么需要生产环境配置

**原因1：安全性**
- 当前.env文件中的JWT_SECRET是占位符，生产环境必须更换
- 数据库密码不应硬编码
- 敏感信息需要安全存储

**原因2：配置管理**
- 不同环境需要不同配置（开发、测试、生产）
- 环境切换需要简单可靠
- 配置变更需要可追踪

**原因3：可维护性**
- 环境变量需要文档说明
- 新人需要知道如何配置环境
- 配置错误需要有明确的提示

#### 不配置生产环境的风险

| 风险类型 | 具体表现 | 影响 |
|---------|---------|------|
| 安全漏洞 | 使用弱密钥或泄露密钥 | 数据泄露，账户被盗 |
| 配置错误 | 环境变量设置不当 | 应用无法启动或运行异常 |
| 部署失败 | 缺少必要的环境变量 | 部署中断，回滚困难 |
| 审计困难 | 配置变更无记录 | 合规性问题，问题排查困难 |

#### 实施建议

**环境变量文档**
```markdown
# 环境变量配置说明

## 必需变量

### 数据库配置
- `DATABASE_URL`: PostgreSQL数据库连接字符串
  - 格式: `postgresql://user:password@host:port/database`
  - 示例: `postgresql://webnote_user:secure_password@db.example.com:5432/webnote_prod`
  - 要求: 生产环境必须使用强密码

### JWT配置
- `JWT_SECRET`: JWT令牌签名密钥
  - 要求: 至少32字符，生产环境必须使用随机生成的强密钥
  - 生成方式: `openssl rand -base64 32`
  - 示例: `aB3xY9zK2mP8qR5tW7nV4cX6sZ1dF8gH2jL4mN6pQ`

### CORS配置
- `ALLOWED_ORIGINS`: 允许的跨域来源
  - 格式: 逗号分隔的URL列表
  - 示例: `https://app.example.com,https://admin.example.com`
  - 要求: 生产环境必须指定具体域名，不要使用通配符

### 服务器配置
- `PORT`: 后端服务端口
  - 默认: `3000`
  - 生产环境: 建议使用3000或其他非特权端口

## 可选变量

### 上传配置
- `MAX_FILE_SIZE`: 最大文件上传大小（字节）
  - 默认: `10485760` (10MB)
  - 示例: `52428800` (50MB)

### 日志配置
- `LOG_LEVEL`: 日志级别
  - 选项: `debug`, `info`, `warn`, `error`
  - 生产环境: 建议使用 `info` 或 `warn`

### Redis配置（未来使用）
- `REDIS_URL`: Redis连接字符串
  - 格式: `redis://host:port`
```

**生产环境配置示例**
```env
# 生产环境配置示例
# 复制此文件为 .env.production 并填入实际值

# 数据库配置
DATABASE_URL=postgresql://webnote_user:CHANGE_THIS_PASSWORD@db.example.com:5432/webnote_prod

# JWT配置 - 必须更改为强密钥
JWT_SECRET=CHANGE_THIS_TO_RANDOM_32_CHAR_STRING

# CORS配置 - 必须更改为实际域名
ALLOWED_ORIGINS=https://app.example.com,https://admin.example.com

# 服务器配置
PORT=3000

# 上传配置
MAX_FILE_SIZE=10485760

# 日志配置
LOG_LEVEL=info
```

**环境验证脚本**
```typescript
// packages/backend/src/utils/env.ts
interface EnvConfig {
  DATABASE_URL: string
  JWT_SECRET: string
  ALLOWED_ORIGINS: string
  PORT: number
  MAX_FILE_SIZE?: number
  LOG_LEVEL?: string
}

export function validateEnv(): EnvConfig {
  const required = [
    'DATABASE_URL',
    'JWT_SECRET',
    'ALLOWED_ORIGINS'
  ]

  const missing = required.filter(key => !process.env[key])
  
  if (missing.length > 0) {
    throw new Error(
      `缺少必需的环境变量: ${missing.join(', ')}\n` +
      `请检查 .env 文件或环境变量配置`
    )
  }

  // 验证JWT_SECRET长度
  if (process.env.JWT_SECRET!.length < 32) {
    throw new Error(
      'JWT_SECRET 长度必须至少为32个字符\n' +
      '生产环境请使用强密钥: openssl rand -base64 32'
    )
  }

  // 验证数据库连接字符串格式
  const dbUrl = process.env.DATABASE_URL!
  if (!dbUrl.startsWith('postgresql://')) {
    throw new Error('DATABASE_URL 必须是 PostgreSQL 连接字符串')
  }

  // 验证端口
  const port = parseInt(process.env.PORT || '3000', 10)
  if (isNaN(port) || port < 1 || port > 65535) {
    throw new Error('PORT 必须是1-65535之间的有效端口号')
  }

  return {
    DATABASE_URL: dbUrl,
    JWT_SECRET: process.env.JWT_SECRET!,
    ALLOWED_ORIGINS: process.env.ALLOWED_ORIGINS!,
    PORT: port,
    MAX_FILE_SIZE: process.env.MAX_FILE_SIZE 
      ? parseInt(process.env.MAX_FILE_SIZE, 10) 
      : 10 * 1024 * 1024,
    LOG_LEVEL: process.env.LOG_LEVEL || 'info'
  }
}

// 在应用启动时验证
export const env = validateEnv()
```

**启动脚本更新**
```typescript
// packages/backend/src/server.ts
import { env } from './utils/env'

async function start() {
  try {
    // 环境变量验证已在导入时完成
    console.log(`✅ 环境变量验证通过`)
    console.log(`📊 数据库: ${env.DATABASE_URL.replace(/:[^:@]+@/, ':****@')}`)
    console.log(`🔐 JWT密钥长度: ${env.JWT_SECRET.length} 字符`)
    console.log(`🌐 允许的来源: ${env.ALLOWED_ORIGINS}`)
    console.log(`🚀 服务端口: ${env.PORT}`)
    
    // ... 启动服务器
  } catch (error) {
    console.error('❌ 启动失败:', error.message)
    process.exit(1)
  }
}

start()
```

#### 预估工作量
- 环境变量文档：0.5天
- 配置示例创建：0.5天
- 验证脚本开发：0.5天
- **总计：1.5天**

---

## 短期行动项（1-2周内）

### 4. 实现CI/CD流程

#### 改进内容
创建完整的持续集成和持续部署流程：
- GitHub Actions工作流
- 自动化测试
- 代码质量检查
- 自动化部署

#### 为什么需要CI/CD

**原因1：自动化**
- 每次代码提交都需要手动运行测试、构建、部署
- 人工操作容易出错
- 效率低下

**原因2：快速反馈**
- 代码问题无法及时发现
- 集成问题延迟发现
- 修复成本高

**原因3：质量保障**
- 代码质量检查需要手动执行
- 无法强制执行质量标准
- 代码审查效率低

**原因4：部署可靠性**
- 手动部署容易出错
- 回滚困难
- 部署历史不可追踪

#### 不实现CI/CD的风险

| 风险类型 | 具体表现 | 影响 |
|---------|---------|------|
| 部署错误 | 手动部署步骤遗漏或错误 | 服务中断，数据丢失 |
| 质量下降 | 代码质量检查遗漏 | 技术债务积累 |
| 效率低下 | 重复性手动工作 | 开发效率低 |
| 反馈延迟 | 问题发现晚 | 修复成本高 |

#### 实施建议

**GitHub Actions工作流**
```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # 代码质量检查
  lint:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 运行ESLint
        run: npm run lint

      - name: 运行TypeScript类型检查
        run: npm run typecheck

  # 运行测试
  test:
    name: 运行测试
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: webnote_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 运行数据库迁移
        run: npm run db:migrate
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/webnote_test

      - name: 运行单元测试
        run: npm run test:unit
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/webnote_test

      - name: 运行集成测试
        run: npm run test:integration
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/webnote_test

      - name: 生成测试覆盖率报告
        run: npm run test:coverage
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/webnote_test

      - name: 上传覆盖率报告
        uses: codecov/codecov-action@v3

  # 构建应用
  build:
    name: 构建应用
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 构建所有包
        run: npm run build

      - name: 构建Docker镜像
        run: |
          docker build -t webnote-backend:${{ github.sha }} -f packages/backend/Dockerfile .
          docker build -t webnote-frontend:${{ github.sha }} -f packages/web/Dockerfile .

      - name: 推送Docker镜像
        if: github.ref == 'refs/heads/main'
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push webnote-backend:${{ github.sha }}
          docker push webnote-frontend:${{ github.sha }}

  # 部署到生产环境
  deploy:
    name: 部署到生产环境
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://app.example.com
    steps:
      - name: 部署到服务器
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd /app/webnote
            docker-compose pull
            docker-compose up -d
            docker system prune -f

      - name: 健康检查
        run: |
          sleep 30
          curl -f https://app.example.com/api/health || exit 1
```

**package.json脚本更新**
```json
{
  "scripts": {
    "lint": "eslint . --ext .ts,.tsx",
    "lint:fix": "eslint . --ext .ts,.tsx --fix",
    "typecheck": "turbo run typecheck",
    "test": "vitest",
    "test:unit": "vitest run --coverage",
    "test:integration": "vitest run --config vitest.integration.config.ts",
    "test:coverage": "vitest run --coverage",
    "build": "turbo run build",
    "db:migrate": "cd packages/backend && npx prisma migrate deploy",
    "db:seed": "cd packages/backend && npx prisma db seed"
  }
}
```

#### 预估工作量
- GitHub Actions配置：2天
- 测试环境搭建：1天
- 部署脚本开发：1-2天
- **总计：4-5天**

---

### 5. 补充文档

#### 改进内容
创建完整的项目文档：
- 部署文档
- API文档
- 开发者指南
- 故障排查指南

#### 为什么需要文档

**原因1：知识传承**
- 团队成员离开时知识流失
- 新人接手困难
- 维护成本高

**原因2：协作效率**
- 团队成员需要理解代码才能有效协作
- 重复回答相同问题
- 代码审查效率低

**原因3：运维支持**
- 部署和运维需要明确的步骤
- 故障排查需要参考文档
- 问题处理效率低

#### 缺少文档的风险

| 风险类型 | 具体表现 | 影响 |
|---------|---------|------|
| 知识流失 | 人员离开导致知识丢失 | 项目难以维护 |
| 效率低下 | 重复沟通和学习 | 开发效率低 |
| 运维困难 | 部署和问题排查困难 | 服务稳定性差 |
| 扩展困难 | 新功能开发困难 | 产品迭代慢 |

#### 实施建议

**部署文档**
```markdown
# 部署文档

## 前置要求

- Docker 20.10+
- Docker Compose 2.0+
- PostgreSQL 15+（如果不使用Docker）
- Node.js 18+（如果不使用Docker）

## 快速开始

### 使用Docker Compose部署

1. 克隆代码仓库
   ```bash
   git clone https://github.com/your-org/webnote.git
   cd webnote
   ```

2. 配置环境变量
   ```bash
   cp .env.example .env
   # 编辑.env文件，填入实际配置
   ```

3. 启动服务
   ```bash
   docker-compose up -d
   ```

4. 验证部署
   ```bash
   curl http://localhost/api/health
   ```

## 生产环境部署

### 使用Docker

1. 构建镜像
   ```bash
   docker build -t webnote-backend:latest -f packages/backend/Dockerfile .
   docker build -t webnote-frontend:latest -f packages/web/Dockerfile .
   ```

2. 配置生产环境变量
   ```bash
   cp .env.production .env
   # 编辑.env文件，确保使用强密钥和安全配置
   ```

3. 启动服务
   ```bash
   docker-compose -f docker-compose.prod.yml up -d
   ```

### 使用传统部署

1. 安装依赖
   ```bash
   npm install
   ```

2. 构建前端
   ```bash
   npm run build -- --filter=web
   ```

3. 构建后端
   ```bash
   npm run build -- --filter=backend
   ```

4. 配置环境变量
   ```bash
   cp .env.production .env
   # 编辑.env文件
   ```

5. 运行数据库迁移
   ```bash
   npm run db:migrate
   ```

6. 启动后端服务
   ```bash
   cd packages/backend
   npm start
   ```

7. 配置Nginx（前端）
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;
       
       root /path/to/packages/web/dist;
       index index.html;
       
       location / {
           try_files $uri $uri/ /index.html;
       }
       
       location /api {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_cache_bypass $http_upgrade;
       }
   }
   ```

## 健康检查

- 后端健康检查: `GET /api/health`
- 前端健康检查: `GET /health`

## 日志查看

- Docker Compose: `docker-compose logs -f`
- Docker: `docker logs -f webnote-backend`

## 故障排查

详见故障排查文档。
```

**API文档**
```markdown
# API文档

## 基础信息

- Base URL: `https://api.example.com`
- 认证方式: JWT Bearer Token
- 内容类型: `application/json`

## 认证

### 注册
- POST `/api/auth/register`
- 请求体:
  ```json
  {
    "email": "user@example.com",
    "password": "password123",
    "name": "User Name"
  }
  ```
- 响应:
  ```json
  {
    "success": true,
    "data": {
      "token": "jwt_token_here",
      "user": {
        "id": 1,
        "email": "user@example.com",
        "name": "User Name"
      }
    }
  }
  ```

### 登录
- POST `/api/auth/login`
- 请求体:
  ```json
  {
    "email": "user@example.com",
    "password": "password123"
  }
  ```
- 响应:
  ```json
  {
    "success": true,
    "data": {
      "token": "jwt_token_here",
      "user": {
        "id": 1,
        "email": "user@example.com",
        "name": "User Name"
      }
    }
  }
  ```

## 笔记

### 获取笔记列表
- GET `/api/notes`
- 认证: 必需
- 查询参数:
  - `page`: 页码（默认1）
  - `limit`: 每页数量（默认20）
  - `search`: 搜索关键词
  - `folder_id`: 文件夹ID
- 响应:
  ```json
  {
    "success": true,
    "data": {
      "notes": [
        {
          "id": 1,
          "title": "Note Title",
          "content": "Note content...",
          "created_at": "2024-01-01T00:00:00Z",
          "updated_at": "2024-01-01T00:00:00Z"
        }
      ],
      "pagination": {
        "page": 1,
        "limit": 20,
        "total": 100
      }
    }
  }
  ```

### 创建笔记
- POST `/api/notes`
- 认证: 必需
- 请求体:
  ```json
  {
    "title": "Note Title",
    "content": "Note content...",
    "folder_id": 1,
    "is_pinned": false
  }
  ```
- 响应:
  ```json
  {
    "success": true,
    "data": {
      "id": 1,
      "title": "Note Title",
      "content": "Note content...",
      "created_at": "2024-01-01T00:00:00Z"
    }
  }
  ```

## 错误码

| 错误码 | 说明 |
|-------|------|
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |
```

**开发者指南**
```markdown
# 开发者指南

## 开发环境设置

### 前置要求
- Node.js 18+
- npm 9+
- PostgreSQL 15+

### 安装步骤

1. 克隆仓库
   ```bash
   git clone https://github.com/your-org/webnote.git
   cd webnote
   ```

2. 安装依赖
   ```bash
   npm install
   ```

3. 配置数据库
   ```bash
   cp packages/backend/.env.example packages/backend/.env
   # 编辑.env文件，配置数据库连接
   ```

4. 运行数据库迁移
   ```bash
   npm run db:migrate
   ```

5. 启动开发服务器
   ```bash
   npm run dev
   ```

## 项目结构

```
webnote/
├── packages/
│   ├── web/              # 前端应用
│   │   ├── src/
│   │   │   ├── components/  # React组件
│   │   │   ├── contexts/    # Context providers
│   │   │   ├── pages/       # 页面组件
│   │   │   └── utils/       # 工具函数
│   │   └── package.json
│   ├── backend/          # 后端应用
│   │   ├── src/
│   │   │   ├── api/         # API路由
│   │   │   ├── middleware/  # 中间件
│   │   │   └── utils/       # 工具函数
│   │   └── package.json
│   └── shared/           # 共享代码
│       ├── src/
│       │   ├── api/         # API客户端
│       │   └── utils/       # 共享工具
│       └── package.json
└── package.json
```

## 开发规范

### 代码风格
- 使用TypeScript
- 遵循ESLint规则
- 使用Prettier格式化

### 提交规范
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式
- refactor: 重构
- test: 测试
- chore: 构建/工具

### 测试要求
- 新功能必须包含测试
- 测试覆盖率不低于80%
- PR必须通过CI检查

## 常见任务

### 添加新API端点
1. 在`packages/backend/src/api/routes.ts`添加路由
2. 更新`packages/shared/src/api/ApiClient.ts`
3. 添加对应的Context方法
4. 编写测试

### 添加新页面
1. 在`packages/web/src/pages/`创建页面组件
2. 在`App.tsx`添加路由
3. 添加导航链接
4. 编写测试
```

#### 预估工作量
- 部署文档：1天
- API文档：1天
- 开发者指南：1天
- 故障排查指南：0.5天
- **总计：3.5天**

---

### 6. 添加监控

#### 改进内容
集成应用监控和告警系统：
- 错误监控（Sentry）
- 性能监控
- 日志聚合
- 告警配置

#### 为什么需要监控

**原因1：问题发现**
- 生产环境问题无法及时发现
- 用户反馈滞后
- 问题影响扩大

**原因2：故障排查**
- 缺乏日志和追踪信息
- 问题定位困难
- 解决时间长

**原因3：性能优化**
- 无法了解系统性能
- 瓶颈难以发现
- 优化无依据

#### 不添加监控的风险

| 风险类型 | 具体表现 | 影响 |
|---------|---------|------|
| 问题发现晚 | 用户先发现问题，运维才知道 | 用户体验差，用户流失 |
| 排查困难 | 缺乏日志和追踪信息 | 解决时间长，成本高 |
| 性能问题 | 无法发现性能瓶颈 | 系统响应慢，资源浪费 |
| 数据丢失 | 错误日志丢失 | 无法分析和改进 |

#### 实施建议

**Sentry集成**
```typescript
// packages/backend/src/utils/sentry.ts
import * as Sentry from "@sentry/node"

export function initSentry() {
  Sentry.init({
    dsn: process.env.SENTRY_DSN,
    environment: process.env.NODE_ENV || "development",
    tracesSampleRate: 1.0,
    beforeSend(event) {
      // 过滤敏感信息
      if (event.request) {
        delete event.request.cookies
        delete event.request.headers
      }
      return event
    }
  })
}

export function captureException(error: Error) {
  Sentry.captureException(error)
}

export function captureMessage(message: string, level: "info" | "warning" | "error") {
  Sentry.captureMessage(message, level)
}
```

**性能监控**
```typescript
// packages/backend/src/middleware/performance.ts
import { performance } from 'perf_hooks'

export function performanceMiddleware(request: any, reply: any, done: any) {
  const start = performance.now()
  
  reply.raw.on('finish', () => {
    const duration = performance.now() - start
    const statusCode = reply.raw.statusCode
    
    // 记录性能指标
    console.log({
      method: request.method,
      url: request.url,
      statusCode,
      duration: `${duration.toFixed(2)}ms`,
      timestamp: new Date().toISOString()
    })
    
    // 慢查询告警
    if (duration > 1000) {
      console.warn(`Slow request detected: ${request.method} ${request.url} - ${duration.toFixed(2)}ms`)
    }
  })
  
  done()
}
```

**健康检查端点**
```typescript
// packages/backend/src/api/routes.ts
app.get('/health', async (request, reply) => {
  try {
    // 检查数据库连接
    await prisma.$queryRaw`SELECT 1`
    
    return reply.send({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      database: 'connected',
      memory: process.memoryUsage()
    })
  } catch (error) {
    reply.status(503).send({
      status: 'unhealthy',
      timestamp: new Date().toISOString(),
      error: error.message
    })
  }
})
```

#### 预估工作量
- Sentry集成：1天
- 性能监控：1天
- 日志聚合：0.5天
- 告警配置：0.5天
- **总计：3天**

---

## 中期行动项（1个月内）

### 7. 完善测试覆盖

#### 改进内容
提高测试覆盖率到80%以上：
- 补充组件测试
- 添加E2E测试
- 提高边界条件测试

#### 预估工作量：1-2周

### 8. 性能优化

#### 改进内容
进行性能测试和优化：
- 数据库查询优化
- 缓存策略实现
- 前端性能优化

#### 预估工作量：1周

### 9. 安全加固

#### 改进内容
进行安全审计和加固：
- 安全漏洞扫描
- 输入验证增强
- 敏感数据加密

#### 预估工作量：1周

---

## 长期优化建议

### 10. 功能扩展

#### 改进内容
添加高级功能：
- 实时协作
- 笔记导出
- 通知系统
- 数据导入/导出

#### 预估工作量：2-3周

### 11. 国际化支持

#### 改进内容
添加多语言支持：
- i18n配置
- 语言包管理
- 语言切换

#### 预估工作量：1周

---

## 总结

### 优先级排序

| 优先级 | 改进项 | 工作量 | 价值 |
|-------|--------|--------|------|
| P0 | 添加基础测试 | 3.5-5.5天 | 高 |
| P0 | 创建Docker配置 | 1.5天 | 高 |
| P0 | 配置生产环境变量 | 1.5天 | 高 |
| P1 | 实现CI/CD流程 | 4-5天 | 高 |
| P1 | 补充文档 | 3.5天 | 中 |
| P1 | 添加监控 | 3天 | 中 |
| P2 | 完善测试覆盖 | 1-2周 | 中 |
| P2 | 性能优化 | 1周 | 中 |
| P2 | 安全加固 | 1周 | 中 |

### 总预估工作量

- **立即行动项（P0）**: 6.5-8.5天
- **短期行动项（P1）**: 10.5-11.5天
- **中期行动项（P2）**: 3-4周

### 建议

1. **第一阶段（1周）**: 完成P0所有项目，确保可以安全部署
2. **第二阶段（2周）**: 完成P1所有项目，提高开发和运维效率
3. **第三阶段（1个月）**: 完成P2所有项目，全面提升项目质量

完成所有改进后，项目将达到生产就绪状态，可以安全地部署到生产环境。
