# 前后端数据连接说明

## 概述

本文档说明 WebNote 项目前后端的数据连接配置和通信方式。

## 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                     前端                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │  React + TypeScript + Vite                 │   │
│  │  - packages/web/src/                        │   │
│  │  - API客户端: packages/web/src/api/index.ts  │   │
│  └──────────────────────────────────────────────────┘   │
│                      │ HTTP/REST API                  │
│                      ↓                                │
└─────────────────────────────────────────────────────────────┘
                       │
                       │ HTTP 请求
                       │
┌─────────────────────────────────────────────────────────────┐
│                   后端                           │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Fastify + Node.js                        │   │
│  │  - packages/backend/src/                     │   │
│  │  - 服务器: packages/backend/src/server.ts     │   │
│  │  - 路由: packages/backend/src/api/routes.ts │   │
│  └──────────────────────────────────────────────────┘   │
│                      │                                 │
│                      │ Prisma ORM                       │
│                      ↓                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  数据库                     │   │
│  │  - PostgreSQL (生产环境)                   │   │
│  │  - SQLite (开发环境)                      │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 前端配置

### API 基础配置

**文件位置**: `packages/web/src/api/index.ts`

```typescript
const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000/api';
```

### 环境变量

**文件位置**: `packages/web/.env.local`

```env
VITE_API_URL=http://localhost:3000/api
```

### API 客户端配置

```typescript
// Axios 实例配置
const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器：添加认证 Token
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// 响应拦截器：处理 401 错误
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.hash = '/login';
    }
    return Promise.reject(error);
  }
);
```

## 后端配置

### 服务器配置

**文件位置**: `packages/backend/src/server.ts`

```typescript
const app = Fastify({
  logger: true
});

// 端口配置
const PORT = process.env.PORT || 3000;
app.listen({ port: Number(PORT) });
```

### CORS 配置

```typescript
app.register(cors, {
  origin: (origin, callback) => {
    const allowedOrigins = process.env.ALLOWED_ORIGINS
      ? process.env.ALLOWED_ORIGINS.split(',')
      : ['http://localhost:5173', 'http://localhost:3000'];
    
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'), false);
    }
  },
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
  credentials: true,
  allowedHeaders: ['Content-Type', 'Authorization'],
  exposedHeaders: ['Authorization'],
  maxAge: 86400 // 24 hours
});
```

### JWT 认证配置

```typescript
app.register(jwt, {
  secret: process.env.JWT_SECRET
});
```

### 环境变量

**文件位置**: `packages/backend/.env`

```env
# 数据库连接
DATABASE_URL="postgresql://webnote_user:webnote_password_2024@120.26.50.152:5432/webnote_db"

# JWT 密钥
JWT_SECRET="your-secret-key-change-in-production-min-32-chars"

# 允许的来源
ALLOWED_ORIGINS="http://localhost:5173,http://localhost:3000"

# 服务器端口
PORT=3000

# 阿里云 OSS 配置
OSS_REGION="oss-cn-hangzhou"
OSS_ACCESS_KEY_ID="your-access-key-id"
OSS_ACCESS_KEY_SECRET="your-access-key-secret"
OSS_BUCKET="your-bucket-name"
OSS_BACKUP_PREFIX="backups"
```

## API 接口列表

### 认证接口 (Auth)

| 方法 | 路径 | 描述 | 认证 |
|------|--------|------|--------|
| POST | `/api/auth/register` | 用户注册 | ❌ |
| POST | `/api/auth/login` | 用户登录 | ❌ |
| POST | `/api/auth/forgot-password` | 忘记密码 | ❌ |
| POST | `/api/auth/reset-password` | 重置密码 | ❌ |

### 用户接口 (User)

| 方法 | 路径 | 描述 | 认证 |
|------|--------|------|--------|
| GET | `/api/user/me` | 获取当前用户信息 | ✅ |
| PUT | `/api/user/me` | 更新当前用户信息 | ✅ |

### 笔记接口 (Notes)

| 方法 | 路径 | 描述 | 认证 |
|------|--------|------|--------|
| POST | `/api/notes` | 创建笔记 | ✅ |
| GET | `/api/notes` | 获取笔记列表 | ✅ |
| GET | `/api/notes/:id` | 获取单个笔记 | ✅ |
| PUT | `/api/notes/:id` | 更新笔记 | ✅ |
| DELETE | `/api/notes/:id` | 删除笔记 | ✅ |
| POST | `/api/notes/batch-delete` | 批量删除笔记 | ✅ |
| POST | `/api/notes/batch-pin` | 批量置顶/取消置顶 | ✅ |

### 文件夹接口 (Folders)

| 方法 | 路径 | 描述 | 认证 |
|------|--------|------|--------|
| POST | `/api/folders` | 创建文件夹 | ✅ |
| GET | `/api/folders` | 获取文件夹列表 | ✅ |
| GET | `/api/folders/:id` | 获取单个文件夹 | ✅ |
| PUT | `/api/folders/:id` | 更新文件夹 | ✅ |
| DELETE | `/api/folders/:id` | 删除文件夹 | ✅ |

### 复盘接口 (Reviews)

| 方法 | 路径 | 描述 | 认证 |
|------|--------|------|--------|
| POST | `/api/reviews` | 创建复盘 | ✅ |
| GET | `/api/reviews` | 获取复盘列表 | ✅ |
| GET | `/api/reviews/:id` | 获取单个复盘 | ✅ |
| PUT | `/api/reviews/:id` | 更新复盘 | ✅ |
| DELETE | `/api/reviews/:id` | 删除复盘 | ✅ |
| GET | `/api/reviews/stats` | 获取复盘统计 | ✅ |

### 备份接口 (Backup)

| 方法 | 路径 | 描述 | 认证 |
|------|--------|------|--------|
| POST | `/api/backups` | 创建备份 | ✅ |
| GET | `/api/backups` | 获取备份列表 | ✅ |
| GET | `/api/backups/:id` | 获取单个备份 | ✅ |
| POST | `/api/backups/:id/restore` | 恢复备份 | ✅ |
| DELETE | `/api/backups/:id` | 删除备份 | ✅ |
| GET | `/api/backups/:id/download` | 下载备份 | ✅ |

### 其他接口

| 方法 | 路径 | 描述 | 认证 |
|------|--------|------|--------|
| GET | `/health` | 健康检查 | ❌ |
| POST | `/api/upload/image` | 上传图片 | ✅ |

## 数据流程

### 用户注册流程

```
前端 ── POST /api/auth/register ──> 后端
      │
      │ { username, email, password }
      │
      ↓
后端
  │
  ├─> 验证输入
  ├─> 检查用户是否存在
  ├─> 加密密码 (bcrypt)
  ├─> 创建用户 (Prisma)
  ├─> 生成 JWT Token
  └─> 返回 { user, token }
```

### 数据创建流程（以笔记为例）

```
前端
  │
  ├─> 用户输入笔记内容
  ├─> 点击保存按钮
  │
  └─> POST /api/notes
       {
         title: "笔记标题",
         content: "笔记内容",
         folder_id: 1,
         is_pinned: false
       }
       │
       ↓
后端
  │
  ├─> 验证 JWT Token
  ├─> 验证数据格式
  ├─> 验证文件夹所有权
  ├─> 创建笔记 (Prisma)
  └─> 返回 { note }
       │
       ↓
前端
  └─> 更新 UI 显示
```

### 数据查询流程

```
前端
  │
  └─> GET /api/notes?search=keyword&sort_by=updated_at
       │
       ↓
后端
  │
  ├─> 验证 JWT Token
  ├─> 解析查询参数
  ├─> 构建查询条件
  ├─> 查询数据库 (Prisma)
  ├─> 应用排序和分页
  └─> 返回 { notes, pagination }
       │
       ↓
前端
  └─> 渲染笔记列表
```

## 认证机制

### JWT Token 流程

```
1. 用户登录
   前端 POST /api/auth/login
   ↓
   后端验证密码，生成 JWT Token
   ↓
   前端存储 Token 到 localStorage

2. 请求受保护资源
   前端从 localStorage 读取 Token
   ↓
   添加到请求头: Authorization: Bearer <token>
   ↓
   后端验证 Token
   ↓
   允许访问或返回 401
```

### Token 存储位置

```typescript
// 前端存储
localStorage.setItem('token', token);
localStorage.setItem('user', JSON.stringify(user));

// 前端读取
const token = localStorage.getItem('token');
const user = JSON.parse(localStorage.getItem('user') || '{}');
```

## 测试连接

### 前端测试页面

已创建连接测试页面：`packages/web/src/pages/ConnectionTestPage.tsx`

访问路径：`http://localhost:5173/#/test-connection`

### 测试项目

1. ✅ 健康检查 - 测试服务器是否运行
2. ✅ 用户注册 - 测试注册接口
3. ✅ 用户登录 - 测试登录接口
4. ✅ 获取用户信息 - 测试认证和用户接口
5. ✅ 创建文件夹 - 测试文件夹接口
6. ✅ 创建笔记 - 测试笔记接口
7. ✅ 获取笔记列表 - 测试查询接口
8. ✅ 创建复盘 - 测试复盘接口
9. ✅ 创建备份 - 测试备份接口
10. ✅ 获取备份列表 - 测试备份查询

### 启动服务器

#### 启动后端

```bash
cd packages/backend
npm run dev
```

服务器将在 `http://localhost:3000` 启动

#### 启动前端

```bash
cd packages/web
npm run dev
```

前端将在 `http://localhost:5173` 启动

### 访问测试页面

在浏览器中访问：`http://localhost:5173/#/test-connection`

点击"运行测试"按钮，查看所有 API 接口的连接状态。

## 数据安全

### HTTPS/TLS

- 生产环境应使用 HTTPS
- 使用 SSL/TLS 加密传输数据

### 密码加密

```typescript
// 使用 bcrypt 加密密码
const hashedPassword = await bcrypt.hash(password, 10);
```

### JWT Token

```typescript
// 生成 JWT Token
const token = app.jwt.sign({ id: user.id, username: user.username });

// 验证 JWT Token
await request.jwtVerify();
```

### CORS 配置

- 限制允许的来源
- 配置允许的 HTTP 方法
- 配置允许的请求头

## 性能优化

### 前端优化

- Axios 拦截器减少重复代码
- 本地存储缓存 Token
- 请求失败自动重试（可扩展）

### 后端优化

- 数据库索引优化
- 查询结果分页
- 响应数据压缩（可配置）

## 错误处理

### 前端错误处理

```typescript
// 响应拦截器处理 401 错误
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // 清除认证信息，跳转登录
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.hash = '/login';
    }
    return Promise.reject(error);
  }
);
```

### 后端错误处理

```typescript
// 全局错误处理器
app.setErrorHandler((error, _, reply) => {
  reply.status(error.statusCode || 500).send({
    success: false,
    error: error.message
  });
});
```

## 扩展性

### WebSocket 实时同步

后端已集成 WebSocket 支持：

```typescript
app.register(websocket);

// WebSocket 连接
ws.on('message', (message) => {
  // 处理实时消息
});
```

### 数据同步服务

- SyncService: 同步服务
- QueueService: 队列服务
- ConflictService: 冲突解决服务

### 备份服务

- BackupService: 备份服务
- Scheduler: 定时任务调度

## 总结

前后端数据连接已完整配置：

✅ **前端 API 客户端**: 完整的 Axios 封装，支持认证和错误处理  
✅ **后端 REST API**: Fastify 服务器，CORS 配置，JWT 认证  
✅ **数据库**: Prisma ORM，支持 PostgreSQL 和 SQLite  
✅ **认证机制**: JWT Token，自动刷新和错误处理  
✅ **测试工具**: 连接测试页面，验证所有接口  

**当前状态**: 前后端代码已完整实现，配置正确，可以进行集成测试。

**下一步**: 
1. 启动后端服务器
2. 启动前端服务器
3. 访问测试页面验证连接
4. 进行端到端测试

---

**文档版本**: 1.0  
**创建日期**: 2026-01-16  
**最后更新**: 2026-01-16
