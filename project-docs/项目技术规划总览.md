# 项目技术规划总览

## 项目概述

### 项目名称
极简网页笔记 + 轻量化日复盘项目

### 项目定位
聚焦MVP核心功能，打造一款极简、轻量化的个人知识管理工具，包含网页笔记和日复盘功能。

### 核心目标
- 25-30天完成MVP核心功能交付
- 实现极简设计理念，轻量化操作
- 确保快速响应，低资源占用
- 采用低成本开发和部署方案

---

## 技术架构

### 整体架构
- **架构类型**：Monorepo（单仓库多包）架构
- **包管理工具**：pnpm + Turborepo
- **开发规范**：TypeScript + ESLint + Prettier

### 技术栈

| 类别 | 技术 | 版本 | 选型理由 |
|------|------|------|----------|
| **前端** | | | |
| 前端框架 | React | 18 | 组件化开发、生态成熟、性能优异 |
| 类型系统 | TypeScript | 5 | 类型安全、代码质量、开发体验 |
| 构建工具 | Vite | 5 | 快速开发体验、现代化构建流程 |
| 路由管理 | React Router | 6 | 声明式路由、代码分割、路由守卫 |
| 状态管理 | React Context API | - | 轻量级、内置支持、适合中小型应用 |
| 数据验证 | Zod | 3 | 类型安全、强大的验证能力 |
| 样式方案 | TailwindCSS | 3 | 实用优先的CSS框架，减少样式代码 |
| HTTP客户端 | 封装的fetch API | - | 原生支持、轻量级、可扩展 |
| **后端** | | | |
| 运行时 | Node.js | 20 | 成熟的JavaScript运行时，生态丰富 |
| 框架 | Fastify | 4.28 | 高性能，低开销，适合轻量化应用 |
| 数据库 | PostgreSQL | 15 | 功能丰富，支持全文搜索，适合结构化数据 |
| 缓存 | Redis | 7 | 高性能缓存，支持多种数据结构 |
| ORM | Prisma | 5 | 类型安全的ORM，自动迁移，开发效率高 |
| 认证 | JWT | - | 无状态认证，适合前后端分离架构 |
| 数据验证 | Zod | 3.20 | 增强数据验证能力，与Prisma结合使用 |
| WebSocket | - | - | 实时数据同步，提升用户体验 |

### 项目结构

```
webnote/
├── packages/
│   ├── web/              # 前端网页应用
│   ├── backend/          # 后端服务
│   ├── shared/           # 公共代码库
│   │   ├── types/        # 类型定义
│   │   ├── utils/        # 工具函数
│   │   ├── api/          # API客户端
│   │   └── constants/    # 常量定义
│   └── ui-components/    # 共享UI组件（可选）
├── package.json          # 根项目配置
├── turbo.json            # Turborepo配置
├── tsconfig.json         # 根TypeScript配置
└── README.md             # 项目说明
```

---

## 核心功能模块

### T0: 项目初始化与架构搭建 ✅ (100%)

**完成日期**: 2026-01-09

**完成内容**:
- ✅ 初始化 Monorepo 目录结构
- ✅ 配置 pnpm + Turborepo
- ✅ 设置 TypeScript、ESLint、Prettier
- ✅ 创建 shared 公共代码包
- ✅ 编写项目初始化文档

---

### T1: 后端核心服务开发 ✅ (100%)

**完成日期**: 2026-01-15

**完成内容**:
- ✅ Fastify 框架搭建
- ✅ 用户认证模块（注册、登录、JWT 鉴权）
- ✅ 数据库模型设计（User, Note, Review, Folder, Backup, SyncQueue）
- ✅ 笔记 API（完整 CRUD + 搜索 + 统计）
- ✅ 复盘 API（完整 CRUD + 统计 + 模板）
- ✅ 数据同步逻辑（SyncService）
- ✅ API 接口测试通过

**后端结构**:
```
backend/
├── src/
│   ├── server.ts              # 服务器配置
│   ├── api/                   # API路由层
│   ├── services/              # 业务逻辑层
│   ├── middlewares/           # 中间件
│   ├── schemas/               # 数据验证层
│   ├── utils/                 # 工具函数
│   └── config/                # 配置
├── prisma/
│   └── schema.prisma          # 数据库模型
└── tests/                    # 测试文件
```

---

### T2: 前端网页应用核心功能 🚧 (90%)

**开始日期**: 2026-01-10

**完成内容**:
- ✅ React + TypeScript + Vite 项目结构
- ✅ 用户认证界面（登录、注册、忘记密码）
- ✅ 笔记列表和详情页
- ✅ Markdown 编辑器集成（react-markdown）
  - 实时预览
  - 工具栏
  - 快捷键
  - 代码高亮
  - 图片上传
- ✅ 日复盘功能（输入、查看、统计）
- ✅ 搜索功能（标题、内容）
- ✅ 基础响应式布局
- ✅ 前端功能测试（22/22 测试通过，100% 通过率）

**进行中**:
- 🚧 完善响应式布局
- 🚧 界面简洁性优化

**待完成**:
- ⏳ 移动端适配优化
- ⏳ 平板设备体验优化
- ⏳ 统一视觉风格
- ⏳ 减少视觉噪音

**前端结构**:
```
web/
├── src/
│   ├── components/    # 通用组件
│   ├── pages/         # 页面组件
│   ├── contexts/      # Context 状态管理
│   ├── hooks/         # 自定义hooks
│   ├── services/      # API服务
│   └── utils/         # 工具函数
└── public/           # 静态资源
```

---

### T3: 数据同步与存储优化 🚧 (90%)

**开始日期**: 2026-01-11

**完成内容**:
- ✅ 后端 SyncService（功能完整度 98%）
  - WebSocket 连接管理
  - 同步请求处理
  - 冲突检测/解决（5 种策略：LATEST_WINS, SERVER_WINS, CLIENT_WINS, MERGE, MANUAL）
  - 心跳机制
  - HTTP 降级
- ✅ 前端 HybridCache（三级缓存架构）
  - Memory 缓存（热数据）
  - IndexedDB 缓存（温数据）
  - LocalStorage 缓存（冷数据）
  - LRU 淘汰策略
  - 数据压缩
  - 一致性检查
- ✅ 前端 SyncManager（同步管理器）
  - 状态机
  - 增量/全量同步
  - 队列管理
  - 冲突解决
  - 事件驱动架构
- ✅ 前端 WebSocketClient（客户端）
  - 连接管理
  - JWT 认证
  - 心跳保活
  - 指数退避重连
  - 消息队列
- ✅ 同步状态 UI 组件（SyncStatus.tsx, ConnectionIndicator.tsx）
- ✅ 数据备份功能（BackupService）
  - 创建备份
  - 获取列表
  - 获取详情
  - 恢复备份
  - 删除备份
  - 下载备份
  - 阿里云 OSS 集成
  - AES-256-GCM 加密
  - 进度回调
  - 自动清理过期备份
- ✅ 前端单元测试（WebSocketClient.test.ts, SyncStatus.test.tsx）

**进行中**:
- 🚧 数据库性能优化

**待完成**:
- ⏳ 添加数据库索引
- ⏳ 查询语句优化
- ⏳ 性能测试和调优
- ⏳ 全面同步功能测试

---

### T4: 用户体验打磨 ⏳ (0%)

**预计工作量**: 5-7 天

**任务清单**:
1. 编辑器响应速度优化（防抖、异步渲染、虚拟滚动）
2. 搜索功能增强（标签过滤、高级搜索、结果排序）
3. 移动端适配优化
4. 交互反馈完善（加载状态、操作提示、Toast 通知）
5. 界面简洁性优化（减少视觉噪音、统一风格）

**优先级**: P2（锦上添花，可延后）

**依赖**: T2 前端完成

---

### T5: 测试与验证 🚧 (10%)

**开始日期**: 2026-01-13

**完成内容**:
- ✅ 前端单元测试开始
- ✅ WebSocketClient 单元测试（完整）
- ✅ SyncStatus 组件单元测试（完整）

**待完成**:
- ⏳ 后端单元测试（API、服务、数据库）
- ⏳ 集成测试（前后端联调、核心流程）
- ⏳ E2E 测试（用户流程、边界情况、兼容性）
- ⏳ 性能测试（页面加载、API 响应、资源使用）
- ⏳ 安全测试（认证安全、数据加密、权限控制）

---

### T6: 部署与监控 ⏳ (0%)

**预计工作量**: 10-15 天

**任务清单**:
1. 开发环境配置（1-2 天）
2. 测试环境配置（2-3 天）
3. 生产环境配置（3-5 天）
4. CI/CD 流程（2-3 天）
5. 前端部署（1-2 天）
6. 后端部署（2-3 天）
7. 监控系统搭建（2-3 天）
8. 日志管理（1-2 天）
9. 文档编写（1-2 天）

**优先级**: P0（必须完成才能上线）

**依赖**: T0-T5 全部完成

---

## 数据库设计

### 核心表结构

**users** - 用户表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | SERIAL | PRIMARY KEY | 用户ID |
| username | VARCHAR(255) | UNIQUE NOT NULL | 用户名 |
| email | VARCHAR(255) | UNIQUE NOT NULL | 邮箱 |
| password_hash | VARCHAR(255) | NOT NULL | 哈希后的密码 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**notes** - 笔记表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | SERIAL | PRIMARY KEY | 笔记ID |
| user_id | INTEGER | REFERENCES users(id) | 用户ID |
| title | VARCHAR(255) | NOT NULL | 笔记标题 |
| content | TEXT | NOT NULL | 笔记内容 |
| folder_id | INTEGER | REFERENCES folders(id) | 文件夹ID |
| is_pinned | BOOLEAN | DEFAULT FALSE | 是否置顶 |
| last_accessed_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 最近访问时间 |
| content_hash | VARCHAR(255) | | 内容哈希值 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**folders** - 文件夹表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | SERIAL | PRIMARY KEY | 文件夹ID |
| user_id | INTEGER | REFERENCES users(id) | 用户ID |
| name | VARCHAR(255) | NOT NULL | 文件夹名称 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**reviews** - 复盘表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | SERIAL | PRIMARY KEY | 复盘ID |
| user_id | INTEGER | REFERENCES users(id) | 用户ID |
| date | DATE | NOT NULL | 复盘日期 |
| content | TEXT | NOT NULL | 复盘内容 |
| mood | INTEGER | | 情绪评分(1-10) |
| achievements | JSONB | | 成就列表 |
| improvements | JSONB | | 改进点列表 |
| plans | JSONB | | 明日计划 |
| template_id | INTEGER | REFERENCES review_templates(id) | 模板ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

### 索引设计

| 表名 | 索引字段 | 索引类型 | 说明 |
|------|----------|----------|------|
| users | (email) | B-tree | 加速邮箱登录查询 |
| notes | (user_id, updated_at) | B-tree | 加速用户笔记列表查询 |
| notes | (user_id, folder_id, updated_at) | B-tree | 加速按文件夹查询笔记 |
| notes | (user_id, is_pinned, updated_at) | B-tree | 加速置顶笔记查询 |
| notes | (title) | B-tree | 加速笔记标题搜索 |
| notes | (content) | GIN | 全文搜索索引 |
| reviews | (user_id, date) | B-tree | 加速用户复盘记录查询 |
| reviews | (user_id, mood, date) | B-tree | 支持情绪分析查询 |
| reviews | (content) | GIN | 全文搜索索引 |

---

## API 设计

### 统一响应格式
```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "code": 200
}
```

### 主要 API 端点

**认证相关**
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/me` - 获取当前用户信息
- `POST /api/auth/refresh` - 刷新令牌

**笔记相关**
- `GET /api/notes` - 获取笔记列表（支持分页、过滤、排序）
- `GET /api/notes/:id` - 获取单个笔记
- `POST /api/notes` - 创建笔记
- `PUT /api/notes/:id` - 更新笔记
- `DELETE /api/notes/:id` - 删除笔记
- `GET /api/notes/search` - 搜索笔记
- `GET /api/notes/statistics` - 获取笔记统计信息

**复盘相关**
- `GET /api/reviews` - 获取复盘列表
- `GET /api/reviews/:id` - 获取单个复盘
- `POST /api/reviews` - 创建复盘
- `PUT /api/reviews/:id` - 更新复盘
- `DELETE /api/reviews/:id` - 删除复盘
- `GET /api/reviews/stats` - 获取复盘统计

**同步相关**
- `GET /api/sync` - 同步数据
- `POST /api/sync` - 上传本地变更
- `GET /api/sync/status` - 获取同步状态
- `POST /api/sync/resolve` - 解决冲突

**WebSocket 事件**
- `note:created` - 笔记创建通知
- `note:updated` - 笔记更新通知
- `note:deleted` - 笔记删除通知
- `review:created` - 复盘创建通知
- `review:updated` - 复盘更新通知
- `review:deleted` - 复盘删除通知
- `sync:status` - 同步状态通知

---

## 同步架构

### 同步协议
**主方案**: WebSocket（实时同步）
- 实时双向通信
- 延迟 < 500ms
- 心跳保活机制
- 指数退避重连

**备用方案**: HTTP 轮询（降级）
- WebSocket 连接失败时自动降级
- 每 5 分钟轮询一次

**离线同步**: HTTP POST
- 批量上传离线数据
- 队列管理
- 网络恢复后自动同步

### 冲突解决策略

1. **LATEST_WINS** - 最后修改优先（默认）
2. **SERVER_WINS** - 服务器版本覆盖本地
3. **CLIENT_WINS** - 本地版本覆盖服务器
4. **MERGE** - 自动合并（简单字段）
5. **MANUAL** - 用户手动解决

### 缓存架构

**三级缓存**:
1. **Memory 缓存** - 热数据，访问最快
2. **IndexedDB 缓存** - 温数据，支持复杂查询，容量大
3. **LocalStorage 缓存** - 冷数据，存储用户设置和认证信息

**缓存策略**:
- 写透 + 失效策略
- LRU 淘汰
- 时间失效（1小时）
- 版本失效

---

## 项目进度

### 整体进度：约 65%

| 子项目 | 进度 | 状态 |
|--------|------|------|
| T0: 项目初始化与架构搭建 | 100% | ✅ 已完成 |
| T1: 后端核心服务开发 | 100% | ✅ 已完成 |
| T2: 前端网页应用核心功能 | 90% | 🚧 进行中 |
| T3: 数据同步与存储优化 | 90% | 🚧 进行中 |
| T4: 用户体验打磨 | 0% | ⏳ 待开始 |
| T5: 测试与验证 | 10% | 🚧 进行中 |
| T6: 部署与监控 | 0% | ⏳ 待开始 |

### 时间线

| 阶段 | 时间 | 主要任务 | 状态 |
|------|------|----------|------|
| T0: 项目初始化与架构搭建 | 2026-01-09 | 目录结构、包管理、开发规范 | ✅ 已完成 |
| T1: 后端核心服务开发 | 2026-01-10 至 2026-01-15 | 认证模块、笔记API、复盘API、数据同步 | ✅ 已完成 |
| T2: 前端核心应用开发 | 2026-01-10 至 2026-01-19 | 认证界面、笔记管理、复盘功能、响应式布局 | 🚧 进行中 |
| T3: 数据同步与存储优化 | 2026-01-11 至 2026-01-23 | 后端同步机制、前端本地缓存、数据库优化 | 🚧 进行中 |
| T4: 用户体验打磨 | 2026-01-24 至 2026-01-27 | 编辑器响应、导航简化、搜索功能、移动端适配 | ⏳ 待开始 |
| T5: 测试与验证 | 2026-01-28 至 2026-02-01 | 单元测试、集成测试、E2E测试、性能测试 | ⏳ 待开始 |
| T6: 部署与监控 | 2026-02-02 至 2026-02-15 | 环境配置、CI/CD、应用部署、监控系统 | ⏳ 待开始 |

---

## 当前核心问题

### P0 - 必须完成（阻塞发布）

1. **T2 响应式布局完善**（预计 3-5 天）
   - [ ] 测试不同设备尺寸
   - [ ] 修复布局问题
   - [ ] 优化触摸交互
   - [ ] 测试主流浏览器兼容性

2. **T2 界面简洁性优化**（预计 3-5 天）
   - [ ] 统一颜色和字体
   - [ ] 优化间距和对齐
   - [ ] 减少视觉噪音
   - [ ] 优化动画效果

3. **T3 数据同步全面测试**（预计 5-7 天）
   - [ ] 冲突解决策略测试
   - [ ] 离线模式测试
   - [ ] 性能测试和调优
   - [ ] 边界情况测试

4. **T3 数据库性能优化**（预计 3-5 天）
   - [ ] 添加关键字段索引
   - [ ] 分析慢查询日志
   - [ ] 优化复杂查询
   - [ ] 连接池优化

### P1 - 重要但可延后

1. **T5 后端单元测试**（预计 5-7 天）
   - [ ] API 测试
   - [ ] 服务测试
   - [ ] 数据库测试

2. **T5 集成测试**（预计 3-5 天）
   - [ ] 前后端联调
   - [ ] 核心流程测试

---

## 部署方案

### 部署平台
- **前端**: Vercel 或 Netlify（静态部署，CDN 加速）
- **后端**: DigitalOcean 或 Vercel Serverless（低成本，易于部署）
- **数据库**: Supabase（托管 PostgreSQL，免费额度足够 MVP）
- **缓存**: Redis Cloud（托管 Redis 服务）

### CI/CD 流程
1. 代码提交到 GitHub
2. GitHub Actions 触发构建
3. 运行单元测试和集成测试
4. 构建前端和后端
5. 部署到测试环境
6. 运行 E2E 测试
7. 部署到生产环境

---

## 风险评估

### 高风险项

| 风险 | 影响 | 可能性 | 应对策略 |
|------|------|--------|----------|
| 数据同步冲突 | 数据不一致 | 中 | 已实现 5 种冲突解决策略，需充分测试 |
| 数据库性能 | 响应缓慢 | 中 | 索引优化、查询优化、缓存策略 |
| 前端性能 | 用户体验差 | 中 | 懒加载、虚拟列表、防抖节流 |

### 中风险项

| 风险 | 影响 | 可能性 | 应对策略 |
|------|------|--------|----------|
| 开发延期 | 项目 delay | 中 | 采用敏捷开发，设置缓冲时间 |
| 测试覆盖不足 | Bug 漏网 | 低 | 建立完善测试体系，提高覆盖率 |

---

## 下一步计划

### 本周（2026-01-16 至 2026-01-22）
1. 第 1-2 天：响应式布局完善
2. 第 3-4 天：界面优化
3. 第 5-7 天：数据同步测试准备

### 下周（2026-01-23 至 2026-01-31）
1. 数据库性能优化（3-5 天）
2. 数据同步全面测试（5-7 天）
3. 前端单元测试（3-5 天）

### 后续（2026-02-01 至 2026-02-15）
1. 后端单元测试（5-7 天）
2. 集成测试（3-5 天）
3. E2E 测试（5-7 天）
4. 用户体验打磨（5-7 天）
5. MVP 发布准备（3-5 天）

---

## 统计数据

### 代码统计
| 指标 | 数值 |
|------|------|
| 总代码行数 | ~15,000 |
| 前端代码 | ~8,000 |
| 后端代码 | ~6,000 |
| 共享代码 | ~1,000 |
| 测试代码 | ~2,000 |
| 文档 | ~5,000 |

### 功能统计
| 功能模块 | 完成度 | 状态 |
|----------|--------|------|
| 用户认证 | 100% | ✅ 已完成 |
| 笔记管理 | 95% | 🚧 进行中 |
| 复盘管理 | 95% | 🚧 进行中 |
| 数据同步 | 90% | 🚧 进行中 |
| 数据备份 | 100% | ✅ 已完成 |
| 搜索功能 | 80% | 🚧 进行中 |
| 响应式布局 | 70% | 🚧 进行中 |
| 单元测试 | 30% | 🚧 进行中 |
| 集成测试 | 0% | ⏳ 待开始 |
| E2E 测试 | 0% | ⏳ 待开始 |

---

**文档版本**: 1.0  
**创建日期**: 2026-01-18  
**最后更新**: 2026-01-18
